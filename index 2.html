<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>HRCAS Demo Dashboard | Multi-Room</title>
  <style>
    :root{
      --bg:#0b1020; --text:rgba(255,255,255,.92); --muted:rgba(255,255,255,.65);
      --line:rgba(255,255,255,.12); --shadow:0 18px 55px rgba(0,0,0,.35); --radius:18px;
      --ok:#2dd4bf; --warn:#fbbf24; --danger:#fb7185; --info:#60a5fa;
    }
    *{box-sizing:border-box}
    body{
      margin:0; color:var(--text);
      font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
      background:
        radial-gradient(1200px 600px at 20% 0%, rgba(96,165,250,.18), transparent 50%),
        radial-gradient(900px 600px at 80% 10%, rgba(45,212,191,.14), transparent 55%),
        radial-gradient(1000px 650px at 50% 100%, rgba(251,113,133,.10), transparent 55%),
        var(--bg);
      min-height:100vh;
    }
    .wrap{max-width:1200px;margin:0 auto;padding:22px;display:grid;gap:16px}
    header{
      display:flex;align-items:flex-start;justify-content:space-between;gap:14px;
      padding:16px 18px;border:1px solid var(--line);border-radius:var(--radius);
      background:linear-gradient(180deg,rgba(255,255,255,.08),rgba(255,255,255,.04));
      box-shadow:var(--shadow)
    }
    .brand h1{font-size:18px;margin:0 0 6px}
    .brand p{margin:0;color:var(--muted);font-size:13px;line-height:1.35}
    .top{display:flex;flex-wrap:wrap;justify-content:flex-end;gap:10px}
    .pill{
      display:flex;align-items:center;gap:10px;min-width:220px;
      border:1px solid var(--line);border-radius:999px;padding:10px 12px;
      background:rgba(255,255,255,.04)
    }
    .dot{width:10px;height:10px;border-radius:999px;background:var(--info);
      box-shadow:0 0 0 5px rgba(96,165,250,.14);flex:0 0 auto}
    .dot.ok{background:var(--ok);box-shadow:0 0 0 5px rgba(45,212,191,.16)}
    .dot.bad{background:var(--danger);box-shadow:0 0 0 5px rgba(251,113,133,.14)}
    .pill small{color:var(--muted);display:block}
    .pill strong{font-weight:900;display:block}

    .grid{display:grid;grid-template-columns:1.55fr .95fr;gap:16px}
    @media(max-width:980px){.grid{grid-template-columns:1fr}.top{justify-content:flex-start}}

    .card{
      border:1px solid var(--line);border-radius:var(--radius);
      background:rgba(255,255,255,.05);box-shadow:var(--shadow);overflow:hidden
    }
    .card h2{
      margin:0;padding:14px 16px;font-size:14px;background:rgba(255,255,255,.04);
      border-bottom:1px solid var(--line);display:flex;align-items:center;justify-content:space-between;gap:10px
    }
    .sub{color:var(--muted);font-size:12px;font-weight:700}

    .scroll{max-height:520px;overflow:auto}
    table{width:100%;border-collapse:collapse}
    th,td{padding:12px 14px;border-bottom:1px solid var(--line);font-size:13px}
    th{color:var(--muted);font-weight:900;text-align:left;background:rgba(255,255,255,.03);position:sticky;top:0;z-index:1}
    .room-name{font-weight:950;display:flex;align-items:center;gap:10px}

    .badge{
      display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border-radius:999px;
      border:1px solid var(--line);background:rgba(255,255,255,.04);font-weight:950;white-space:nowrap
    }
    .mini-dot{width:8px;height:8px;border-radius:999px;background:var(--ok);box-shadow:0 0 0 4px rgba(45,212,191,.12)}
    .risk-ok{--risk:var(--ok)} .risk-warn{--risk:var(--warn)} .risk-danger{--risk:var(--danger)}
    .risk-ok .badge,.risk-warn .badge,.risk-danger .badge{
      border-color:color-mix(in srgb,var(--risk),transparent 65%);
      background:color-mix(in srgb,var(--risk),transparent 90%)
    }
    .risk-ok .mini-dot,.risk-warn .mini-dot,.risk-danger .mini-dot{
      background:var(--risk);box-shadow:0 0 0 4px color-mix(in srgb,var(--risk),transparent 82%)
    }

    .kpi{display:grid;grid-template-columns:repeat(2,1fr);gap:10px;padding:14px}
    .tile{border:1px solid var(--line);border-radius:14px;padding:12px;background:rgba(255,255,255,.04)}
    .label{color:var(--muted);font-size:12px;margin-bottom:6px;font-weight:900}
    .value{font-size:18px;font-weight:950}
    .hint{margin-top:6px;color:var(--muted);font-size:12px;line-height:1.35}

    .alerts{padding:10px;display:flex;flex-direction:column;gap:10px}
    .alert{border:1px solid var(--line);border-radius:14px;padding:12px;background:rgba(255,255,255,.04);display:flex;gap:12px;align-items:flex-start}
    .stamp{width:10px;height:10px;border-radius:999px;margin-top:4px;background:var(--info);box-shadow:0 0 0 5px rgba(96,165,250,.14);flex:0 0 auto}
    .alert.warn .stamp{background:var(--warn);box-shadow:0 0 0 5px rgba(251,191,36,.14)}
    .alert.danger .stamp{background:var(--danger);box-shadow:0 0 0 5px rgba(251,113,133,.14)}
    .meta strong{font-size:13px;font-weight:950;display:block}
    .meta span{color:var(--muted);font-size:12px;line-height:1.35;display:block;margin-top:4px}
    .tag{font-size:12px;color:var(--muted);border:1px solid var(--line);border-radius:999px;padding:6px 10px;background:rgba(255,255,255,.03);white-space:nowrap}
    footer{color:var(--muted);font-size:12px;padding:10px 2px 0;text-align:center;line-height:1.35}

    .unlock{
      position:fixed;inset:auto 16px 16px auto;max-width:420px;
      border:1px solid var(--line);border-radius:16px;background:rgba(15,23,42,.72);
      padding:12px 14px;box-shadow:var(--shadow);backdrop-filter:blur(10px);
      display:flex;gap:10px;align-items:flex-start
    }
    .unlock.hidden{display:none}
    .unlock strong{font-size:13px;display:block}
    .unlock span{font-size:12px;color:var(--muted);line-height:1.35;display:block;margin-top:4px}
    .unlock .stamp{background:var(--warn);box-shadow:0 0 0 5px rgba(251,191,36,.14)}
  </style>
</head>

<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <h1>HRCAS Dashboard üõ°Ô∏è | Heat Risk & Climate Adaptive Safety</h1>
        <p> Read-only facility view: temperature, humidity, heat risk classification,
      occupancy status, and intelligent voice alerts (with prioritisation and cooldown control).</p>
        <p style="margin-top:6px;color:var(--muted)">
          Shortcuts: <b>1</b>=Warn R01, <b>2</b>=Danger R01, <b>3</b>=Danger R02, <b>R</b>=Heat wave, <b>0</b>=Reset.
        </p>
      </div>
      <div class="top">
        <div class="pill">
          <span id="audioDot" class="dot bad"></span>
          <div>
            <small>Voice</small>
            <strong id="audioText">Locked (click once)</strong>
          </div>
        </div>
        <div class="pill">
          <span class="dot ok"></span>
          <div>
            <small>Mode</small>
            <strong>Demo Data</strong>
          </div>
        </div>
        <div class="pill">
          <span class="dot" style="background:var(--info)"></span>
          <div>
            <small>Last update</small>
            <strong id="lastUpdate">--:--:--</strong>
          </div>
        </div>
      </div>
    </header>

    <div class="grid">
      <section class="card">
        <h2>Rooms status <span class="sub">read-only view</span></h2>
        <div class="scroll">
          <table>
            <thead>
              <tr>
                <th>Room</th>
                <th>Heat Risk</th>
                <th>Temp</th>
                <th>Humidity</th>
                <th>heatDanger</th>
              </tr>
            </thead>
            <tbody id="roomsBody"></tbody>
          </table>
        </div>
      </section>

      <aside class="card">
        <h2>Facility snapshot <span class="sub">fast triage</span></h2>
        <div class="kpi">
          <div class="tile">
            <div class="label">Rooms in Danger</div>
            <div class="value" id="kpiDanger">0</div>
            <div class="hint">Danger overrides warning for audio</div>
          </div>
          <div class="tile">
            <div class="label">Rooms in Warning</div>
            <div class="value" id="kpiWarn">0</div>
            <div class="hint">Near threshold</div>
          </div>
          <div class="tile">
            <div class="label">Avg. Temp</div>
            <div class="value" id="kpiTemp">--</div>
            <div class="hint">Across rooms</div>
          </div>
          <div class="tile">
            <div class="label">Avg. Humidity</div>
            <div class="value" id="kpiHum">--</div>
            <div class="hint">Across rooms</div>
          </div>
        </div>

        <h2 style="border-top:1px solid var(--line);">Alerts <span class="tag" id="alertsCount">0 active</span></h2>
        <div class="alerts" id="alertsList" aria-live="polite"></div>
      </aside>
    </div>

    <footer>
      Audio note: browsers require one click to allow speech. For your own voice, use MP3/WAV files (easy swap later).
    </footer>
  </div>

  <div id="unlock" class="unlock" role="note" aria-live="polite">
    <span class="stamp"></span>
    <div>
      <strong>Audio locked by browser</strong>
      <span>Click/tap once anywhere to enable voice warnings.</span>
    </div>
  </div>

  <script>
    // =========================
    // DEMO CONFIG
    // =========================
    const TEMP_WARN = 33.0;
    const TEMP_DANGER = 35.0;

    // Alert behavior
    const AUDIO_COOLDOWN_MS = 25_000; // demo-friendly
    let lastSpokenAt = 0;
    let lastSpokenKey = "";
    let audioUnlocked = false;

    // Set to true only if you want the keyboard demo triggers active.
    const ENABLE_DEMO_KEYS = true;

    // Demo rooms (multiple)
    const rooms = Array.from({length: 8}, (_, i) => ({
      id: i+1,
      name: `Room ${String(i+1).padStart(2,"0")}`,
      temperature: 26.0 + (i*0.2),
      humidity: 48 + (i % 3)*4,
      heatDanger: false,
      risk: "ok",
      ts: Date.now()
    }));

    function fmt(n, d=1){ return (n==null || Number.isNaN(n)) ? "--" : Number(n).toFixed(d); }

    function computeRisk(r){
      if (r.heatDanger === true) return "danger";
      if (r.temperature >= TEMP_DANGER) return "danger";
      if (r.temperature >= TEMP_WARN) return "warn";
      return "ok";
    }

    function speak(text){
      if (!("speechSynthesis" in window)) return;
      if (!audioUnlocked) return;

      const now = Date.now();
      if (now - lastSpokenAt < AUDIO_COOLDOWN_MS) return;

      window.speechSynthesis.cancel();
      const u = new SpeechSynthesisUtterance(text);
      u.rate = 1.05;
      u.pitch = 1.0;
      u.volume = 1.0;
      window.speechSynthesis.speak(u);

      lastSpokenAt = now;
    }

    function unlockAudio(){
      audioUnlocked = true;
      document.getElementById("unlock").classList.add("hidden");
      document.getElementById("audioDot").classList.remove("bad");
      document.getElementById("audioDot").classList.add("ok");
      document.getElementById("audioText").textContent = "Enabled";
      speak("Voice warnings enabled.");
    }
    document.addEventListener("click", unlockAudio, { once:true });
    document.addEventListener("keydown", unlockAudio, { once:true });
    document.addEventListener("touchstart", unlockAudio, { once:true });

    function renderAlerts(alerts){
      const list = document.getElementById("alertsList");
      list.innerHTML = "";

      if (!alerts.length){
        const div = document.createElement("div");
        div.className = "alert";
        div.innerHTML = `
          <span class="stamp"></span>
          <div class="meta">
            <strong>No active alerts</strong>
            <span>All rooms are stable.</span>
          </div>
        `;
        list.appendChild(div);
        return;
      }

      alerts.slice(0, 10).forEach(a => {
        const div = document.createElement("div");
        div.className = `alert ${a.level}`;
        div.innerHTML = `
          <span class="stamp"></span>
          <div class="meta">
            <strong>${a.title}</strong>
            <span>${a.detail}</span>
          </div>
        `;
        list.appendChild(div);
      });
    }

    function handleAudio(){
      const dangerRooms = rooms.filter(r => r.risk === "danger");
      const warnRooms = rooms.filter(r => r.risk === "warn");

      let msg = "";
      let key = "";

      // PRIORITY: danger wins
      if (dangerRooms.length > 0){
        const names = dangerRooms.slice(0,3).map(r => r.name.replace("Room ",""));
        msg = (dangerRooms.length <= 3)
          ? `Somebody's gon die! Danger in rooms ${names.join(", ")}.`
          : `Somebody's gon die! Danger in ${dangerRooms.length} rooms.`;
        key = "D:" + dangerRooms.map(r => r.id).sort((a,b)=>a-b).join(",");
      } else if (warnRooms.length > 0){
        const names = warnRooms.slice(0,3).map(r => r.name.replace("Room ",""));
        msg = (warnRooms.length <= 3)
          ? `Oh sh*t. Oh sh*t. Heat rising in rooms ${names.join(", ")}.`
          : `Oh sh*t. Oh sh*t. Heat rising in ${warnRooms.length} rooms.`;
        key = "W:" + warnRooms.map(r => r.id).sort((a,b)=>a-b).join(",");
      } else {
        lastSpokenKey = "";
        return;
      }

      // DEDUPE: speak only if the active set changed
      if (key !== lastSpokenKey){
        lastSpokenKey = key;
        speak(msg);
      }
    }

    function render(){
      const tbody = document.getElementById("roomsBody");
      tbody.innerHTML = "";

      let danger=0, warn=0, sumT=0, sumH=0;

      const alerts = [];

      rooms.forEach(r => {
        r.risk = computeRisk(r);
        if (r.risk === "danger") danger++;
        if (r.risk === "warn") warn++;
        sumT += r.temperature;
        sumH += r.humidity;

        if (r.risk === "danger"){
          alerts.push({
            level: "danger",
            title: `${r.name}: Heat danger`,
            detail: `Temp ${fmt(r.temperature)}¬∞C, Hum ${fmt(r.humidity)}%. heatDanger=${r.heatDanger}.`
          });
        } else if (r.risk === "warn"){
          alerts.push({
            level: "warn",
            title: `${r.name}: Heat warning`,
            detail: `Temp ${fmt(r.temperature)}¬∞C (near ${TEMP_DANGER}¬∞C).`
          });
        }

        const tr = document.createElement("tr");
        tr.className = `risk-${r.risk}`;
        tr.innerHTML = `
          <td><div class="room-name">${r.name}</div></td>
          <td><span class="badge"><span class="mini-dot"></span>${r.risk.toUpperCase()}</span></td>
          <td>${fmt(r.temperature)}¬∞C</td>
          <td>${fmt(r.humidity)}%</td>
          <td>${r.heatDanger ? "true" : "false"}</td>
        `;
        tbody.appendChild(tr);
      });

      document.getElementById("kpiDanger").textContent = danger;
      document.getElementById("kpiWarn").textContent = warn;
      document.getElementById("kpiTemp").textContent = `${fmt(sumT/rooms.length)}¬∞C`;
      document.getElementById("kpiHum").textContent = `${fmt(sumH/rooms.length)}%`;

      document.getElementById("alertsCount").textContent = `${alerts.length} active`;
      renderAlerts(alerts);

      document.getElementById("lastUpdate").textContent =
        new Date().toLocaleTimeString([], {hour:"2-digit", minute:"2-digit", second:"2-digit"});

      // Speak based on current states (priority + summary + cooldown)
      handleAudio();
    }

    // =========================
    // DEMO CONTROLS (optional)
    // =========================
    function resetAll(){
      rooms.forEach((r,i)=>{
        r.temperature = 26.0 + (i*0.2);
        r.humidity = 48 + (i % 3)*4;
        r.heatDanger = false;
        r.ts = Date.now();
      });
      lastSpokenKey = "";
      render();
    }

    if (ENABLE_DEMO_KEYS){
      document.addEventListener("keydown", (e)=>{
        const k = e.key.toLowerCase();
        if (k === "0") resetAll();

        if (k === "1"){
          const r = rooms[0];
          r.temperature = TEMP_WARN + 0.2;
          r.heatDanger = false;
          r.ts = Date.now();
          render();
        }

        if (k === "2"){
          const r = rooms[0];
          r.temperature = TEMP_DANGER + 0.4;
          r.heatDanger = true;
          r.ts = Date.now();
          render();
        }

        if (k === "3"){
          const r = rooms[1];
          r.temperature = TEMP_DANGER + 0.2;
          r.heatDanger = true;
          r.ts = Date.now();
          render();
        }

        if (k === "r"){
          // heat wave across multiple rooms
          rooms.forEach((r,i)=>{
            r.temperature = 32.5 + (i*0.4); // some go warn, some go danger
            r.heatDanger = (r.temperature >= TEMP_DANGER);
            r.ts = Date.now();
          });
          render();
        }
      });
    }

    // initial paint
    render();
  </script>
</body>
</html>
